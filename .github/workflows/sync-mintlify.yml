name: Sync Release to Mintlify

on:
  repository_dispatch:
    types:
      - new-release-note
  workflow_dispatch:
    inputs:
      ref:
        description: "Tag ref (e.g. refs/tags/v6.4.0)"
        required: true
      repository:
        description: "SDK repo (e.g. box/box-windows-sdk-v2)"
        required: true
      labels:
        description: "Labels (e.g. sdks,windows)"
        required: true
      repo_display_name:
        description: "Display name (e.g. Box Windows SDK)"
        required: true

concurrency:
  group: mintlify-changelog-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout changelog repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # Extract payload either from the event or manual workflow dispatch
      - name: Extract payload
        id: payload
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ref=${{ github.event.client_payload.ref }}" >> "$GITHUB_OUTPUT"
            echo "repository=${{ github.event.client_payload.repository }}" >> "$GITHUB_OUTPUT"
            echo "labels=${{ github.event.client_payload.labels }}" >> "$GITHUB_OUTPUT"
            echo "repo_display_name=${{ github.event.client_payload.repo_display_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.event.inputs.ref }}" >> "$GITHUB_OUTPUT"
            echo "repository=${{ github.event.inputs.repository }}" >> "$GITHUB_OUTPUT"
            echo "labels=${{ github.event.inputs.labels }}" >> "$GITHUB_OUTPUT"
            echo "repo_display_name=${{ github.event.inputs.repo_display_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout box-mintlify
        uses: actions/checkout@v6
        with:
          repository: box/box-mintlify
          token: ${{ secrets.MINTLIFY_TOKEN }}
          path: box-mintlify

      - name: Convert and generate Mintlify entry
        id: convert
        env:
          REF: ${{ steps.payload.outputs.ref }}
          REPOSITORY: ${{ steps.payload.outputs.repository }}
          LABELS: ${{ steps.payload.outputs.labels }}
          REPO_DISPLAY_NAME: ${{ steps.payload.outputs.repo_display_name }}
          MINTLIFY_REPO_PATH: ${{ github.workspace }}/box-mintlify
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node code/src/MintlifySync/index.js

      - name: Create PR in box-mintlify
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.MINTLIFY_TOKEN }}
        working-directory: box-mintlify
        run: |
          OUTPUT_JSON="/tmp/mintlify-sync-output.json"
          if [ ! -f "$OUTPUT_JSON" ]; then
            echo "Expected output file not found: $OUTPUT_JSON"
            exit 1
          fi

          COMPONENT_NAME="$(jq -r '.componentName' "$OUTPUT_JSON")"
          FILE_PATH="$(jq -r '.filePath' "$OUTPUT_JSON")"
          PR_TITLE="$(jq -r '.prTitle' "$OUTPUT_JSON")"
          RELEASE_URL="$(jq -r '.releaseUrl' "$OUTPUT_JSON")"

          BRANCH_NAME="changelog-sync/${COMPONENT_NAME}"
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            BRANCH_NAME="${BRANCH_NAME}-${GITHUB_RUN_ID}"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git add "${FILE_PATH}" "changelog/index.mdx"

          if git diff --cached --quiet; then
            echo "No changes detected, skipping commit and PR creation."
            echo "pr_url=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "${PR_TITLE}"
          git push -u origin "$BRANCH_NAME"

          PR_URL="$(gh pr create \
            --repo box/box-mintlify \
            --title "${PR_TITLE}" \
            --body "$(cat <<EOF
          ## Summary
          - Adds changelog entry for this release
          - Source: [Release](${RELEASE_URL})

          ## Files changed
          - \`${FILE_PATH}\` (new file)
          - \`changelog/index.mdx\` (modified: added import + component usage)

          ---
          *Auto-generated by sync-mintlify workflow in box-developer-changelog*
          EOF
          )")"
          echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"

      - name: Notify Slack (success)
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.create_pr.outputs.pr_url != '' && format('Changelog sync to Mintlify opened PR: {0} {1} <{2}|Open PR>', steps.payload.outputs.repo_display_name, steps.payload.outputs.ref, steps.create_pr.outputs.pr_url) || format('Changelog sync to Mintlify completed with no changes: {0} {1}', steps.payload.outputs.repo_display_name, steps.payload.outputs.ref) }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify Slack (failure)
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Changelog sync to Mintlify FAILED: ${{ steps.payload.outputs.repo_display_name }} ${{ steps.payload.outputs.ref }}. Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
